extends /layout/forms

block beforehtml
  -
    title = 'AiTAGO 折扣碼模板'
    description = '快速分享折扣碼的 Flex Message 模板'

block meta
  meta(property="og:image:height", content="640")
  meta(property="og:image:width", content="1280")
  meta(property="og:image", content="https://storage.googleapis.com/feature-dev/line_crm/images/8e/d6/1f/8ed61f12149f6ff917358b35be4de7f5.png")
  meta(property="og:url", content=baseurl+"forms/aitago-coupon-1.html")

block form
  .form-group.was-validated.my-2
    label(for="vcard-altText") 替代文字
    input#vcard-altText.form-control.form-control-sm(type="text", required, pattern=".+", v-model="vcard.altText")
    small.form-text.text-muted 請填寫在訊息無法顯示時（如：系統通知）的替代文字。
  .form-group.was-validated.my-2
    label(for="vcard-hero") 主圖
    input#vcard-hero.form-control.form-control-sm(type="url", inputmode="url", required, pattern="https://\\S+", v-model.trim="vcard.hero")
    small.form-text.text-muted 請填寫主圖圖片網址，必須是 #[code https://] 開頭，長寬比為 #[code 20:13]。
  .form-group.was-validated.my-2
    label(for="vcard-title") 標題
    input#vcard-title.form-control.form-control-sm(type="text", required, pattern=".+", v-model="vcard.title")
    small.form-text.text-muted 請填寫標題。
  .form-group.was-validated.my-2
    label(for="vcard-desc") 說明
    textarea#vcard-desc.form-control.form-control-sm(required, pattern=".+", v-model="vcard.desc")
    small.form-text.text-muted 請填寫說明文字。
  .form-group.was-validated.my-2
    label(for="vcard-coupon") 優惠碼
    input#vcard-coupon.form-control.form-control-sm(type="text", required, pattern=".+", v-model="vcard.coupon")
    small.form-text.text-muted 請填寫優惠碼。
  .form-group.my-2
    label(for="vcard-couponLabel") 優惠碼標籤
    input#vcard-couponLabel.form-control.form-control-sm(type="text", v-model="vcard.couponLabel")
    small.form-text.text-muted 請填寫優惠碼標籤，預設為「優惠碼」。
  .form-group.was-validated.my-2
    label(for="vcard-link") 連結
    input#vcard-link.form-control.form-control-sm(type="url", inputmode="url", required, pattern="(https?://|line://|tel:|mailto:)\\S+", v-model.trim="vcard.link")
    small.form-text.text-muted 請填寫連結。你可以使用 #[a(target="_blank", href="https://ga-dev-tools.appspot.com/campaign-url-builder/") UTM Builder] 以及 #[code &amp;openExternalBrowser=1] 另開瀏覽器。
  .form-group.was-validated.my-2
    label(for="vcard-buttonText") 按鈕文字
    input#vcard-buttonText.form-control.form-control-sm(type="text", required, pattern=".+", v-model="vcard.buttonText")
    small.form-text.text-muted 請填寫按鈕文字。
  .form-group.was-validated.my-2
    label(for="vcard-buttonColor") 按鈕顏色
    input#vcard-buttonColor.form-control.form-control-sm(type="text", required, pattern="#[0-9A-Fa-f]{6}", v-model.trim="vcard.buttonColor")
    small.form-text.text-muted 請填寫按鈕顏色，格式為 #[code #RRGGBB]（例如：#[code #133CB6]）。
  .form-group.my-2
    label(for="vcard-titleColor") 標題顏色
    input#vcard-titleColor.form-control.form-control-sm(type="text", pattern="#[0-9A-Fa-f]{6}", v-model.trim="vcard.titleColor")
    small.form-text.text-muted 請填寫標題顏色，格式為 #[code #RRGGBB]（例如：#[code #133CB6]），預設為 #[code #133CB6]。

  hr.my-4
  h5 預覽 Flex Message JSON
  .input-group.my-2
    button.btn.btn-outline-info.flex-fill(type="button", @click="btnPreviewFlex") #[i.fa.mr-2.fa-eye] 生成 Flex JSON
  #modal-preview-flex.modal.fade(data-backdrop="static", data-keyboard="false", tabindex="-1", ref="modalPreviewFlex")
    .modal-dialog.modal-dialog-centered.modal-xl
      .modal-content
        .modal-header
          h5.modal-title Flex Message JSON（可貼到 #[a(target="_blank", href="https://developers.line.biz/flex-simulator/") LINE Flex Message Simulator]）
        .modal-body
          textarea.form-control.form-control-sm.flex-fill(v-model="previewFlexJson", rows="15", style="font-family: monospace; font-size: 12px;")
        .modal-footer
          button.btn.btn-outline-success(type="button", @click="btnCopy(previewFlexJson, $refs['modalPreviewFlex'])") 複製 JSON
          button.btn.btn-secondary(type="button", @click="jqModal('modalPreviewFlex', 'hide')") 關閉
          a.btn.btn-primary(target="_blank", :href="'https://developers.line.biz/flex-simulator/?input=' + encodeURIComponent(previewFlexJson)", :disabled="!previewFlexJson") 開啟 Simulator
  small.form-text.text-muted 點擊「生成 Flex JSON」可產生完整的 Flex Message JSON，可直接貼到 LINE Flex Message Simulator 預覽。

  hr.my-4
  h5 獨立分享連結
  .input-group.my-2
    input.form-control.form-control-sm(type="text", readonly, :value="shortcut || ''")
    .input-group-append
      button.btn.btn-outline-secondary(type="button", @click="btnCopy(shortcut)", :disabled="!shortcut") 複製
  small.form-text.text-muted(v-if="shortcut") 此連結已包含目前表單資料，分享或收藏後可直接開啟 LIFF 使用。
  small.form-text.text-muted(v-else) 請先填寫表單讓系統生成您的專屬連結。

block vue-config
  script.
    const cfg = window.vueConfig
    _.set(cfg, 'data.vcard', {
      altText: 'AiTAGO 折扣碼訊息',
      buttonColor: '#133CB6',
      buttonText: '前往使用',
      coupon: 'LINE999',
      couponLabel: '優惠碼',
      desc: '憑優惠碼至官網消費可享 9 折優惠~',
      hero: 'https://storage.googleapis.com/feature-dev/line_crm/images/31/d2/9b/31d29b8ca5bb1c1c26bccc8f13121202.png',
      link: 'https://example.com',
      template: '#{baseurl}cards/aitago-coupon-1.txt',
      title: '歡迎領取優惠碼',
      titleColor: '#133CB6',
    })
    _.set(cfg, 'data.previewFlexJson', '')
    cfg.computed = {
      ...cfg.computed,
      shortcut () {
        const params = window.httpBuildQuery({
          template: window.encodeBase64url(this.vcard.template),
          json5gzip: window.encodeGzip(JSON5.stringify(window.beautifyFlex(_.omit(this.vcard, ['template'])))),
        })
        if (!_.isString(params) || !params.length) return
        return `https://liff.line.me/#{liffidFull}/share-json5gzip.html?${params}`
      },
    }
    cfg.methods = {
      ...cfg.methods,
      async btnPreviewFlex () {
        try {
          // 直接構建 Bubble JSON（LINE Simulator 需要 bubble 對象，不是完整的 flex 包裝）
          const vcard = this.vcard
          const mockLiffLink = 'https://liff.line.me/1234567890-abcdefgh/share.html'
          
          // 構建 Bubble 對象（Simulator 格式）
          const bubbleJson = {
            type: 'bubble',
            size: 'giga',
            hero: {
              type: 'image',
              url: vcard.hero,
              size: 'full',
              aspectRatio: '20:13',
              aspectMode: 'cover'
            },
            body: {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'text',
                  text: vcard.title,
                  weight: 'bold',
                  size: 'xl',
                  color: vcard.titleColor || '#133CB6',
                  wrap: true
                },
                {
                  type: 'text',
                  text: vcard.desc,
                  size: 'md',
                  wrap: true
                },
                {
                  type: 'box',
                  layout: 'vertical',
                  margin: 'lg',
                  spacing: 'sm',
                  contents: [
                    {
                      type: 'text',
                      text: vcard.couponLabel || '優惠碼',
                      size: 'sm',
                      color: '#666666'
                    },
                    {
                      type: 'text',
                      text: vcard.coupon,
                      weight: 'bold',
                      size: 'lg',
                      color: '#FF0000',
                      decoration: 'underline',
                      wrap: true
                    }
                  ]
                },
                {
                  type: 'box',
                  layout: 'vertical',
                  position: 'absolute',
                  offsetStart: '0px',
                  offsetTop: '0px',
                  width: '1px',
                  height: '1px',
                  contents: [
                    {
                      type: 'image',
                      url: 'https://www.google-analytics.com/collect?measurement_id=G-GZZ1VHK5ZD&api_secret=preview&json=preview',
                      size: 'full',
                      aspectRatio: '1:1',
                      aspectMode: 'cover',
                      gravity: 'center',
                      align: 'center'
                    }
                  ]
                }
              ],
              paddingAll: '20px',
              spacing: 'md'
            },
            footer: {
              type: 'box',
              layout: 'vertical',
              spacing: 'sm',
              contents: [
                {
                  type: 'button',
                  action: {
                    type: 'uri',
                    label: vcard.buttonText || '前往使用',
                    uri: _.trim(vcard.link)
                  },
                  style: 'primary',
                  height: 'sm',
                  color: vcard.buttonColor || '#133CB6'
                },
                {
                  type: 'button',
                  action: {
                    type: 'uri',
                    label: 'Share - 分享',
                    uri: mockLiffLink
                  },
                  style: 'primary',
                  height: 'sm',
                  color: '#0000ff'
                }
              ]
            }
          }
          
          // 轉換為格式化的 JSON 字串，並清理所有非標準空白字符
          let jsonString = JSON.stringify(bubbleJson, null, 2)
          // 移除所有非標準空白字符（U+00A0 等），只保留標準空格（U+0020）、換行符和回車符
          // 使用正則表達式替換所有非標準空白字符為標準空格
          jsonString = jsonString.replace(/[\u00A0\u2000-\u200B\u202F\u205F\u3000]/g, ' ')
          
          this.previewFlexJson = jsonString
          this.jqModal('modalPreviewFlex', 'show')
        } catch (err) {
          window.logError({ err })
          await Swal.fire({ icon: 'error', title: '生成失敗', text: err.message })
        }
      },
    }

